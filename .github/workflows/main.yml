name: Build MegaDumper

on:
  # push:
  #   branches: [ "main", "master" ]
  # pull_request:
  #   branches: [ "main", "master" ]
  workflow_dispatch: # 允许手动触发工作流

jobs:
  build:
    # 必须使用 windows-latest，因为项目是 net8.0-windows 和 WinForms
    runs-on: windows-latest
    
    strategy:
      matrix:
        # 同时编译 x86 和 x64 平台
        platform: [x86, x64]
        configuration: [Release]

    steps:
    - name: 检出代码 (Checkout code)
      uses: actions/checkout@v4

    # - name: 安装 .NET 8 SDK (Setup .NET)
    #   uses: actions/setup-dotnet@v4
    #   with:
    #     dotnet-version: '8.0.x'

    - name: 还原依赖 (Restore dependencies)
      # 这里假设你的 csproj 文件在 MegaDumper 目录下。如果有 sln 文件，也可以直接 restore sln
      run: dotnet restore MegaDumper/MegaDumper.csproj

    - name: 编译项目 (Build)
      run: dotnet build MegaDumper/MegaDumper.csproj --configuration ${{ matrix.configuration }} -p:Platform=${{ matrix.platform }} --no-restore

    - name: 发布单文件独立程序 (Publish Full/Self-Contained)
      run: dotnet publish MegaDumper/MegaDumper.csproj -c ${{ matrix.configuration }} -r win-${{ matrix.platform }} --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish_full

    - name: 发布框架依赖精简版 (Publish Lite/Framework-Dependent)
      run: dotnet publish MegaDumper/MegaDumper.csproj -c ${{ matrix.configuration }} -r win-${{ matrix.platform }} --self-contained false -o ./publish_lite

    - name: 上传完整版 (Upload Full Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: MegaDumper-Full-win-${{ matrix.platform }}
        path: ./publish_full/

    - name: 上传精简版 (Upload Lite Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: MegaDumper-Lite-win-${{ matrix.platform }}
        path: ./publish_lite/
